name: Automation Executor Continuous

# This workflow runs continuously to process automation jobs
on:
  schedule:
    # Run every 2 minutes (GitHub's minimum reliable interval)
    - cron: '*/2 * * * *'
  
  # Allow manual triggering for testing
  workflow_dispatch:

jobs:
  automation-executor:
    runs-on: ubuntu-latest
    
    steps:
      - name: Call Automation Executor API
        run: |
          echo "üöÄ [CONTINUOUS] Calling automation executor API..."
          echo "‚è∞ Current time: $(date)"
          
          # Call the API with timeout
          response=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Content-Type: application/json" \
            --max-time 30 \
            https://myblipp.com/api/_cron/automation-executor)
          
          # Extract response body and status code
          http_code=$(echo "$response" | tail -n1)
          response_body=$(echo "$response" | head -n -1)
          
          echo "üìä Response Status: $http_code"
          echo "üìä Response Body: $response_body"
          
          # Check if the response was successful
          if [ "$http_code" -eq 200 ]; then
            echo "‚úÖ Automation executor called successfully!"
            
            # Parse the response to get job counts
            processed_automations=$(echo "$response_body" | grep -o '"processedAutomations":[0-9]*' | grep -o '[0-9]*')
            processed_requests=$(echo "$response_body" | grep -o '"processedRequests":[0-9]*' | grep -o '[0-9]*')
            
            echo "üìà Processed Automations: $processed_automations"
            echo "üìà Processed Requests: $processed_requests"
            
            if [ "$processed_automations" -gt 0 ]; then
              echo "üéâ $processed_automations automation jobs processed!"
            else
              echo "‚ÑπÔ∏è  No automation jobs to process at this time"
            fi
          else
            echo "‚ùå Error calling automation executor (HTTP $http_code)"
            echo "Response: $response_body"
            # Don't exit 1 for continuous runs to avoid spam
          fi
          
      - name: Log Execution Time
        run: |
          echo "‚è∞ [CONTINUOUS] Execution completed at: $(date)"
          echo "üîÑ Next execution will be in 2 minutes"
